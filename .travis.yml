os: linux
dist: xenial
language: minimal

# only run CI-builds on gh-pages branch
branches:
  only:
    - gh-pages

services:
  - docker

before_install:
  - docker build -t keepaliveit/jekyll-gulp-docker ./jekyll-gulp-docker -f jekyll-gulp-docker/Dockerfile
  - docker run -it --rm -v $(pwd):/srv -w="/srv/" keepaliveit/jekyll-gulp-docker chown -R jekyll /srv/.jekyll-cache/ && chown -R jekyll /srv/_site/ && npm run build:test

# setup npm and set execution permission on our build script
before_script:
  - chmod +xrw ./scripts/cibuild.sh

# path to our build script.
# Travis will run `bundle install` by default before running our script
script: ./scripts/cibuild.sh

addons:
  apt:
    packages:
    - libcurl4-openssl-dev

deploy:
  strategy: git
  provider: pages
  cleanup: true
  token: $GH_TOKEN
  keep_history: true
  committer_from_gh: true
  target_branch: master
  local_dir: ./_site
  fqdn: staging.keepaliveit.co.uk
  on:
    branch: gh-pages